######################################################################################################################
# Use for collecting trading data from an incoming Pump&Dump. Start few time before the event.
#
# The script saves all the trades executed on a given pair <pnd_pair> of a given exchange <exchange> at filepath
# "data/trades/<pnd_pair>.csv". Moreover, it saves all order book updates (i.e., buy and sell limit order postings,
# even not executed) of such pair at filepath "data/depth/<pnd_pair>.csv".
# If <pnd_pair> is not given, the script considers all tradable pairs having the quote asset equals to <quote_asset>.
# If <quote_asset> is not given either, the script considers all tradable pairs for the given exchange.
# In these two last cases, each pair will be saved in a separate file.
######################################################################################################################


import binance
import kucoin
import pathlib
import utils


pnd_pair = None         # The pumped pair
quote_asset = 'BTC'     # The quote asset of the pumped pair (not required if <pnd_pair> is given)
exchange = 'binance'    # Must be given


def callback_depth(msg):
    if exchange == 'binance':
        if msg['e'] == 'depthUpdate':
            symbol = msg['s']
            with open(f'data/depth/{symbol}.csv', 'a') as f:
                f.write(str(msg) + '\n')
        else:
            print('Unknown msg: ', msg)
    elif exchange == 'kucoin':
        raise Exception('Not implemented yet.')
    else:
        raise Exception('Exchange not found.')


def callback_trade(msg):
    if exchange == 'binance':
        if msg['e'] == 'trade':
            symbol = msg['s']
            with open(f'data/trades/{symbol}.csv', 'a') as f:
                f.write(str(msg) + '\n')
        else:
            print('Unknown msg: ', msg)
    elif exchange == 'kucoin':
        raise Exception('Not implemented yet.')
    else:
        raise Exception('Exchange not found.')


if __name__ == '__main__':

    if exchange == 'binance':
        client = binance.Client()
        info = client.get_exchange_info()
        if pnd_pair:
            symbols = [pnd_pair]
        else:
            symbols = [obj['symbol'] for obj in info['symbols']
                       if obj['status'] == 'TRADING' and obj['symbol'].endswith(quote_asset)]

        twm = binance.ThreadedWebsocketManager()
        twm.start()

        pathlib.Path('data/depth').mkdir(parents=True, exist_ok=True)
        pathlib.Path('data/trades').mkdir(parents=True, exist_ok=True)

        for symbol in symbols:
            twm.start_trade_socket(callback=callback_trade, symbol=symbol)
            twm.start_depth_socket(callback=callback_depth, symbol=symbol)

        twm.join()

    elif exchange == 'kucoin':
        raise Exception('Not implemented yet.')

    else:
        raise Exception('Exchange not found.')
