import json

import binance
import kucoin
import pandas as pd
import telethon


BINANCE_TRADES_COLS = ['Event type', 'Event time', 'Symbol', 'Trade ID', 'Price', 'Quantity', 'Buyer order ID',
                       'Seller order ID', 'Trade time', 'Is the buyer the market maker?', 'Ignore']


def get_client(account, fp='cred.json'):
    if account == 'binance':
        with open(fp) as f:
            cred = json.load(f)
            return binance.Client(cred['binance']['key'], cred['binance']['secret'])
    elif account == 'binance_sub':
        with open(fp) as f:
            cred = json.load(f)
            return binance.Client(cred['binance_sub']['key'], cred['binance_sub']['secret'])
    elif account == 'kucoin':
        raise Exception('Not implemented yet.')
    else:
        raise Exception('account not found.')


def get_telegram_client(fp='cred.json'):
    with open(fp) as f:
        cred = json.load(f)
        return telethon.TelegramClient('anon', cred['telegram']['key'], cred['telegram']['hash'])


def get_quote_quantity(usd_amount: float, symbol: str, other_asset: str = 'USDT') -> str:
    """
    Get the quote asset quantity (returned as a string) for the specified symbol from a given USD amount.
    Use Binance quotes.
    """
    if symbol[-4:] in ['USDT', 'USDC', 'BUSD', 'TUSD', 'USDP']:
        return usd_amount
    client = binance.Client('', '')
    print(f'Getting {symbol} information...')
    info1 = client.get_symbol_info(symbol=symbol)
    if info1:
        base_asset, quote_asset = info1['baseAsset'], info1['quoteAsset']
        print(f'Getting {quote_asset + other_asset} information...')
        info2 = client.get_symbol_info(symbol=quote_asset + other_asset)
        if info2:
            print(f'Getting {quote_asset + other_asset} last price...')
            last_price = float(client.get_ticker(symbol=quote_asset + other_asset)['lastPrice'])
            precision = info2['quoteAssetPrecision']
            quote_quantity = usd_amount / last_price
            return f'{quote_quantity:.{precision}f}'
        else:
            raise Exception(f'Symbol {symbol} not found on Binance.')
    else:
        raise Exception(f'Symbol {symbol} not found on Binance.')
